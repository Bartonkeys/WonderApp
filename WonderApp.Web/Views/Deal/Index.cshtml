@model IEnumerable<WonderApp.Models.DealModel>
@Styles.Render("~/Content/css_bundle_datatables")

@{
    ViewBag.Title = "Wonders";    
}


<h2>Wonders</h2>

<p>
    <a class="btn btn-success" href="@Url.Action("Create")">Create Wonder</a>
</p>

@if (!Model.Any())
{
<p>No wonders at moment.</p>
}
else
{
    <table class="table table-striped table-responsive table-nonfluid" id="dealList">
        <thead>
            <tr>
                <th class="col-md-1 details-control">
                    
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Title)
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Tags)
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.IntroDescription)
                </th>
                <th class="col-md-2">
                    City
                </th>
                <th class="col-md-2">
                    Season
                </th>
                <th class="col-md-2">
                    Company
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Likes)
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Priority)
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Expired)
                </th>
                <th class="col-md-2">
                    
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.Category)
                </th>
               
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td class="details-control" id="@item.Id"></td>
                    <td>
                        <div class="input-group">
                            <span class="input-group-addon">#</span>
                            @Html.DisplayFor(modelItem => item.Title)
                        </div>
                        
                    </td>
                    <td>
                        @foreach (var tag in item.Tags)
                        {
                            <span class="tags">
                                @(tag.Name)
                            </span>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IntroDescription)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.City.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Season.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Company.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Likes)
                    </td>
                    <td id="@item.Id" onclick="priorityClicked(@item.Id)">
                        @Html.CheckBoxFor(modelItem => item.Priority)
                    </td>
                    <td id="@item.Id" onclick="expiredClicked(@item.Id)">
                        @Html.CheckBoxFor(modelItem => item.Expired)
                    </td>
                    <td>
                        <a title="Copy Wonder" class="btn btn-sm btn-warning" onclick="copyClicked(@item.Id)"><i class="fa fa-files-o fa-lg"></i></a>

                        @if (ViewBag.isAdmin || item.Creator != null && item.Creator.Id == ViewBag.userId)
                        {
                            <a title="Edit Wonder" class="btn btn-sm btn-info" href="@Url.Action("Edit",new{id = item.Id})"><i class="fa fa-pencil-square-o fa-lg"></i></a>
                            <a title="Delete Wonder" class="btn btn-sm btn-danger" href="@Url.Action("Delete", new{id = item.Id})"><i class="fa fa-times fa-lg"></i></a>
                       
                        }

                        
                    </td>
                   
                    <td>
                        @Html.DisplayFor(modelItem => item.Category)
                    </td>

                </tr>
                
            }
        </tbody>
    </table>

    @section Scripts {
        @Scripts.Render("~/bundles/dataTables")
        
      
        <script type="text/javascript">

            function copyClicked(cid) {


                $.isLoading({ text: "Copying wonder..." });
                $.ajax("/Deal/Copy/" + cid, {
                    dataType: "json",
                    type: "POST"
                }).done(function(data) {
                    if (data != null) {
                        $.isLoading("hide");
                        toastr.success('Wonder successfully copied');
                        $.isLoading({ text: "Loading new wonder..." });
                        $(location).attr('href', '/Deal/Edit/' + data);
                    } else {
                        $.isLoading("hide");
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    toastr.error('Error copying wonder - please try again')
                    $.isLoading("hide");

                });
            }

            function priorityClicked(cid) {


                $.isLoading({ text: "Updating priority..." });
                $.ajax("/api/Tag/UpdatePriority/" + cid, {
                    dataType: "json",
                    type: "PUT"
                }).done(function(data) {
                    if (data != null) {
                        $(this).prop('checked', data);
                        toastr.success('Priority successfully updated')
                    }
                    $.isLoading("hide");
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    toastr.error('Error setting the priority - please try again')
                    $.isLoading("hide");

                });
            }

            function expiredClicked(cid) {


                $.isLoading({ text: "Updating expired..." });
                $.ajax("/api/Tag/UpdateExpired/" + cid, {
                    dataType: "json",
                    type: "PUT"
                }).done(function(data) {
                    if (data != null) {
                        $(this).prop('checked', data);
                        toastr.success('Expired successfully updated')
                    }
                    $.isLoading("hide");
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    toastr.error('Error setting the wonder expired - please try again')
                    $.isLoading("hide");

                });
            }

            $(document).ready(function() {

                var dTable;

                // Add event listener for opening and closing details
                $('#dealList tbody').on('click', 'td.details-control', function() {
                    var tr = $(this).closest('tr');
                    var row = dTable.row(tr);

                    if (row.child.isShown()) {
                        // This row is already open - close it
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        // Open this row
                        $.isLoading({ text: "Loading wonder detail..." });
                        var dealId = this.id; //$(this).attr("rel");                   
                        $.get("/Deal/DealDetail?dealId=" + dealId, function(deals) {
                            row.child(deals).show();
                            tr.addClass('shown');
                            $.isLoading("hide");
                        }).fail(function(jqXHR, textStatus, errorThrown) {
                            toastr.error('Error loading the wonder detail - please try again')
                            $.isLoading("hide");

                        });
                        ;
                    }

                });

                //dTable = $('#dealList').DataTable({
                //    "bSortable": false, "aTargets": [0,1]
                //});

                dTable = $('#dealList').DataTable({
                    "aoColumns": [
                        { "bVisible": true, "bSearchable": false, "bSortable": false},
                        { "bVisible": true, "bSearchable": true, "bSortable": false},
                        { "bVisible": true, "bSearchable": true, "bSortable": false},
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": true, "bSearchable": true, "bSortable": false },
                        { "bVisible": false, "bSearchable": true, "bSortable": false }
                    ],
                    "aaSorting": []
                });

                yadcf.init(dTable, [{
                    column_number: 4,
                    filter_default_label: "Choose"
                }, {
                    column_number: 5,
                    filter_default_label: "Choose"
                }, {
                    column_number: 6,
                    filter_default_label: "Choose"
                }
                //{column_number : 0},
                //{column_number : 1, filter_type: "range_number_slider", filter_container_id: "external_filter_container"},
                //{column_number : 2, data: ["Yes", "No"], filter_default_label: "Select Yes/No"},
                //{column_number : 3, filter_type: "auto_complete", text_data_delimiter: ","},
                //{column_number : 4, column_data_type: "html", html_data_type: "text", filter_default_label: "Select tag"}
                ]);

                
                
             

            });            

        //Add a clickable link to the priority checkbox
            //$("#dealList").on("click", "td", function () {
            //    alert($(this).text());
            //});
            
            //$('#dealList tr td').click(function () {
            //    var cid = $(this).attr('id');

            //    $.isLoading({ text: "Updating priority..." });
            //    $.ajax("/api/Tag/UpdatePriority/" + cid, {
            //        dataType: "json",
            //        type: "PUT"
            //    }).done(function (data) {
            //        if (data != null) {
            //            $(this).prop('checked', data);
            //            toastr.success('Priority successfully updated')
            //        }
            //        $.isLoading("hide");
            //    }).fail(function (jqXHR, textStatus, errorThrown) {
            //        toastr.error('Error setting the priority - please try again')
            //        $.isLoading("hide");

            //    });
            //});

        </script>

    }

    
    
}


