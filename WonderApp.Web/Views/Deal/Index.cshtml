@model IEnumerable<WonderApp.Models.DealSummaryModel>

@{
    ViewBag.Title = "Wonders";
}


<h2>Wonders</h2>

<p>
    <a class="btn btn-success" href="@Url.Action("Create")">Create Wonder</a>
</p>

@if (!Model.Any())
{
<p>No wonders at moment.</p>
}
else
{
    <table class="table table-striped table-responsive table-nonfluid" id="dealList">
        <thead>
            <tr>
                <th class="col-md-1 details-control">
                    
                </th>
                <th class="col-md-2">
                    @Html.DisplayNameFor(model => model.Title)
                </th>
                <th class="col-md-2">
                    @Html.DisplayNameFor(model => model.Tags)
                </th>
                <th class="col-md-2">
                    @Html.DisplayNameFor(model => model.IntroDescription)
                </th>
                <th class="col-md-2">
                    Company
                </th>
                <th class="col-md-2">
                    City
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Likes)
                </th>
                <th class="col-md-1">
                    @Html.DisplayNameFor(model => model.Priority)
                </th>
                <th class="col-md-2"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td class="details-control" id="@item.Id"></td>
                    <td>
                        <div class="input-group">
                            <span class="input-group-addon">#</span>
                            @Html.DisplayFor(modelItem => item.Title)
                        </div>
                        
                    </td>
                    <td>
                        @foreach (var tag in item.Tags)
                        {
                            <span class="tags">
                                @(tag.Name)
                            </span>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.IntroDescription)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Company.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.City.Name)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Likes)
                    </td>
                    <td id="@item.Id" onclick="priorityClicked(@item.Id)">
                        @Html.CheckBoxFor(modelItem => item.Priority)
                    </td>
                    <td>
                        <a title="Copy Wonder" class="btn btn-sm btn-warning" onclick="copyClicked(@item.Id)"><i class="fa fa-files-o fa-lg"></i></a>

                        @if (ViewBag.isAdmin || (ViewBag.userId == item.Creator_User_Id))
                        {
                            <a title="Edit Wonder" class="btn btn-sm btn-info" href="@Url.Action("Edit",new{id = item.Id})"><i class="fa fa-pencil-square-o fa-lg"></i></a>
                            <a title="Delete Wonder" class="btn btn-sm btn-danger" href="@Url.Action("Delete", new{id = item.Id})"><i class="fa fa-times fa-lg"></i></a>
                       
                        }

                        
                    </td>

                </tr>
            }
        </tbody>
    </table>

    @section Scripts {
        @Scripts.Render("~/bundles/dataTables")
        
      
        <script type="text/javascript">


            function copyClicked(cid) {


                $.isLoading({ text: "Copying wonder..." });
                $.ajax("/Deal/Copy/" + cid, {
                    dataType: "json",
                    type: "POST"
                }).done(function (data) {
                    if (data != null) {
                        $.isLoading("hide");
                        toastr.success('Wonder successfully copied');
                        $.isLoading({ text: "Loading new wonder..." });
                        $(location).attr('href','/Deal/Edit/' + data);
                    }
                    else{
                        $.isLoading("hide");
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    toastr.error('Error copying wonder - please try again')
                    $.isLoading("hide");

                });
            }

            function priorityClicked(cid){
                

                $.isLoading({ text: "Updating priority..." });
                $.ajax("/api/Tag/UpdatePriority/" + cid, {
                    dataType: "json",
                    type: "PUT"
                }).done(function (data) {
                    if (data != null) {
                        $(this).prop('checked', data);
                        toastr.success('Priority successfully updated')
                    }
                    $.isLoading("hide");
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    toastr.error('Error setting the priority - please try again')
                    $.isLoading("hide");

                });
            }

            $(document).ready(function() {

                var dTable;
               
                // Add event listener for opening and closing details
                $('#dealList tbody').on('click', 'td.details-control', function() {
                    var tr = $(this).closest('tr');
                    var row = dTable.row(tr);

                    if (row.child.isShown()) {
                        // This row is already open - close it
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        // Open this row
                        $.isLoading({ text: "Loading wonder detail..." });
                        var dealId = this.id; //$(this).attr("rel");                   
                        $.get("/Deal/DealDetail?dealId=" + dealId, function(deals) { 
                            row.child(deals).show();
                            tr.addClass('shown');
                            $.isLoading("hide");
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            toastr.error('Error loading the wonder detail - please try again')
                            $.isLoading("hide");

                        });;
                    }

                });

                dTable = $('#dealList').DataTable({
                    "bSortable": false, "aTargets": [0,1]
                });
               

            });
            

            //Add a clickable link to the priority checkbox
            //$("#dealList").on("click", "td", function () {
            //    alert($(this).text());
            //});
            
            //$('#dealList tr td').click(function () {
            //    var cid = $(this).attr('id');

            //    $.isLoading({ text: "Updating priority..." });
            //    $.ajax("/api/Tag/UpdatePriority/" + cid, {
            //        dataType: "json",
            //        type: "PUT"
            //    }).done(function (data) {
            //        if (data != null) {
            //            $(this).prop('checked', data);
            //            toastr.success('Priority successfully updated')
            //        }
            //        $.isLoading("hide");
            //    }).fail(function (jqXHR, textStatus, errorThrown) {
            //        toastr.error('Error setting the priority - please try again')
            //        $.isLoading("hide");

            //    });
            //});

        </script>

    }

    
    
}


